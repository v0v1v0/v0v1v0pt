<div class="container">

<table style="width: 100%;"><tr>
<td>plot_anomaly_diagnostics</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Visualize Anomalies for One or More Time Series</h2>

<h3>Description</h3>

<p>An interactive and scalable function for visualizing anomalies in time series data.
Plots are available in interactive <code>plotly</code> (default) and static <code>ggplot2</code> format.
</p>


<h3>Usage</h3>

<pre><code class="language-R">plot_anomaly_diagnostics(
  .data,
  .date_var,
  .value,
  .facet_vars = NULL,
  .frequency = "auto",
  .trend = "auto",
  .alpha = 0.05,
  .max_anomalies = 0.2,
  .message = TRUE,
  .facet_ncol = 1,
  .facet_nrow = 1,
  .facet_scales = "free",
  .facet_dir = "h",
  .facet_collapse = FALSE,
  .facet_collapse_sep = " ",
  .facet_strip_remove = FALSE,
  .line_color = "#2c3e50",
  .line_size = 0.5,
  .line_type = 1,
  .line_alpha = 1,
  .anom_color = "#e31a1c",
  .anom_alpha = 1,
  .anom_size = 1.5,
  .ribbon_fill = "grey20",
  .ribbon_alpha = 0.2,
  .legend_show = TRUE,
  .title = "Anomaly Diagnostics",
  .x_lab = "",
  .y_lab = "",
  .color_lab = "Anomaly",
  .interactive = TRUE,
  .trelliscope = FALSE,
  .trelliscope_params = list()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>.data</code></td>
<td>
<p>A <code>tibble</code> or <code>data.frame</code> with a time-based column</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.date_var</code></td>
<td>
<p>A column containing either date or date-time values</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.value</code></td>
<td>
<p>A column containing numeric values</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.facet_vars</code></td>
<td>
<p>One or more grouping columns that broken out into <code>ggplot2</code> facets.
These can be selected using <code>tidyselect()</code> helpers (e.g <code>contains()</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.frequency</code></td>
<td>
<p>Controls the seasonal adjustment (removal of seasonality).
Input can be either "auto", a time-based definition (e.g. "2 weeks"),
or a numeric number of observations per frequency (e.g. 10).
Refer to <code>tk_get_frequency()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.trend</code></td>
<td>
<p>Controls the trend component.
For STL, trend controls the sensitivity of the LOESS smoother, which is used to remove the remainder.
Refer to <code>tk_get_trend()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.alpha</code></td>
<td>
<p>Controls the width of the "normal" range. Lower values are more conservative
while higher values are less prone to incorrectly classifying "normal" observations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.max_anomalies</code></td>
<td>
<p>The maximum percent of anomalies permitted to be identified.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.message</code></td>
<td>
<p>A boolean. If <code>TRUE</code>, will output information related to automatic frequency
and trend selection (if applicable).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.facet_ncol</code></td>
<td>
<p>Number of facet columns.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.facet_nrow</code></td>
<td>
<p>Number of facet rows (only used for <code>.trelliscope = TRUE</code>)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.facet_scales</code></td>
<td>
<p>Control facet x &amp; y-axis ranges. Options include "fixed", "free", "free_y", "free_x"</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.facet_dir</code></td>
<td>
<p>The direction of faceting ("h" for horizontal, "v" for vertical). Default is "h".</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.facet_collapse</code></td>
<td>
<p>Multiple facets included on one facet strip instead of
multiple facet strips.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.facet_collapse_sep</code></td>
<td>
<p>The separator used for collapsing facets.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.facet_strip_remove</code></td>
<td>
<p>Whether or not to remove the strip and text label for each facet.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.line_color</code></td>
<td>
<p>Line color.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.line_size</code></td>
<td>
<p>Line size.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.line_type</code></td>
<td>
<p>Line type.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.line_alpha</code></td>
<td>
<p>Line alpha (opacity). Range: (0, 1).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.anom_color</code></td>
<td>
<p>Color for the anomaly dots</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.anom_alpha</code></td>
<td>
<p>Opacity for the anomaly dots. Range: (0, 1).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.anom_size</code></td>
<td>
<p>Size for the anomaly dots</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.ribbon_fill</code></td>
<td>
<p>Fill color for the acceptable range</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.ribbon_alpha</code></td>
<td>
<p>Fill opacity for the acceptable range. Range: (0, 1).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.legend_show</code></td>
<td>
<p>Toggles on/off the Legend</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.title</code></td>
<td>
<p>Plot title.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.x_lab</code></td>
<td>
<p>Plot x-axis label</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.y_lab</code></td>
<td>
<p>Plot y-axis label</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.color_lab</code></td>
<td>
<p>Plot label for the color legend</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.interactive</code></td>
<td>
<p>If TRUE, returns a <code>plotly</code> interactive plot.
If FALSE, returns a static <code>ggplot2</code> plot.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.trelliscope</code></td>
<td>
<p>Returns either a normal plot or a trelliscopejs plot (great for many time series)
Must have <code>trelliscopejs</code> installed.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>.trelliscope_params</code></td>
<td>
<p>Pass parameters to the <code>trelliscopejs::facet_trelliscope()</code> function as a <code>list()</code>.
The only parameters that cannot be passed are:
</p>

<ul>
<li> <p><code>ncol</code>: use <code>.facet_ncol</code>
</p>
</li>
<li> <p><code>nrow</code>: use <code>.facet_nrow</code>
</p>
</li>
<li> <p><code>scales</code>: use <code>facet_scales</code>
</p>
</li>
<li> <p><code>as_plotly</code>: use <code>.interactive</code>
</p>
</li>
</ul>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The <code>plot_anomaly_diagnostics()</code> is a visualization wrapper for <code>tk_anomaly_diagnostics()</code>
group-wise anomaly detection, implements a 2-step process to
detect outliers in time series.
</p>
<p><strong>Step 1: Detrend &amp; Remove Seasonality using STL Decomposition</strong>
</p>
<p>The decomposition separates the "season" and "trend" components from the "observed" values
leaving the "remainder" for anomaly detection.
</p>
<p>The user can control two parameters: frequency and trend.
</p>

<ol>
<li> <p><code>.frequency</code>: Adjusts the "season" component that is removed from the "observed" values.
</p>
</li>
<li> <p><code>.trend</code>: Adjusts the trend window (t.window parameter from <code>stats::stl()</code> that is used.
</p>
</li>
</ol>
<p>The user may supply both <code>.frequency</code> and <code>.trend</code> as time-based durations (e.g. "6 weeks") or
numeric values (e.g. 180) or "auto", which predetermines the frequency and/or trend based on
the scale of the time series using the <code>tk_time_scale_template()</code>.
</p>
<p><strong>Step 2: Anomaly Detection</strong>
</p>
<p>Once "trend" and "season" (seasonality) is removed, anomaly detection is performed on the "remainder".
Anomalies are identified, and boundaries (recomposed_l1 and recomposed_l2) are determined.
</p>
<p>The Anomaly Detection Method uses an inner quartile range (IQR) of +/-25 the median.
</p>
<p><em>IQR Adjustment, alpha parameter</em>
</p>
<p>With the default <code>alpha = 0.05</code>, the limits are established by expanding
the 25/75 baseline by an IQR Factor of 3 (3X).
The <em>IQR Factor = 0.15 / alpha</em> (hence 3X with alpha = 0.05):
</p>

<ul>
<li>
<p> To increase the IQR Factor controlling the limits, decrease the alpha,
which makes it more difficult to be an outlier.
</p>
</li>
<li>
<p> Increase alpha to make it easier to be an outlier.
</p>
</li>
<li>
<p> The IQR outlier detection method is used in <code>forecast::tsoutliers()</code>.
</p>
</li>
<li>
<p> A similar outlier detection method is used by Twitter's <code>AnomalyDetection</code> package.
</p>
</li>
<li>
<p> Both Twitter and Forecast tsoutliers methods have been implemented in Business Science's <code>anomalize</code>
package.
</p>
</li>
</ul>
<h3>Value</h3>

<p>A <code>plotly</code> or <code>ggplot2</code> visualization
</p>


<h3>References</h3>


<ol>
<li>
<p> CLEVELAND, R. B., CLEVELAND, W. S., MCRAE, J. E., AND TERPENNING, I.
STL: A Seasonal-Trend Decomposition Procedure Based on Loess.
Journal of Official Statistics, Vol. 6, No. 1 (1990), pp. 3-73.
</p>
</li>
<li>
<p> Owen S. Vallis, Jordan Hochenbaum and Arun Kejariwal (2014).
A Novel Technique for Long-Term Anomaly Detection in the Cloud. Twitter Inc.
</p>
</li>
</ol>
<h3>See Also</h3>


<ul><li> <p><code>tk_anomaly_diagnostics()</code>: Group-wise anomaly detection
</p>
</li></ul>
<h3>Examples</h3>

<pre><code class="language-R">library(dplyr)

walmart_sales_weekly %&gt;%
    group_by(id) %&gt;%
    plot_anomaly_diagnostics(Date, Weekly_Sales,
                             .message = FALSE,
                             .facet_ncol = 3,
                             .ribbon_alpha = 0.25,
                             .interactive = FALSE)



</code></pre>


</div>