<div class="container">

<table style="width: 100%;"><tr>
<td>step_ts_clean</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Clean Outliers and Missing Data for Time Series</h2>

<h3>Description</h3>

<p><code>step_ts_clean</code> creates a <em>specification</em> of a recipe
step that will clean outliers and impute time series data.
</p>


<h3>Usage</h3>

<pre><code class="language-R">step_ts_clean(
  recipe,
  ...,
  period = 1,
  lambda = "auto",
  role = NA,
  trained = FALSE,
  lambdas_trained = NULL,
  skip = FALSE,
  id = rand_id("ts_clean")
)

## S3 method for class 'step_ts_clean'
tidy(x, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>recipe</code></td>
<td>
<p>A <code>recipe</code> object. The step will be added to the sequence of operations for this recipe.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>One or more selector functions to choose which
variables are affected by the step. See <code>selections()</code>
for more details. For the <code>tidy</code> method, these are not
currently used.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>period</code></td>
<td>
<p>A seasonal period to use during the transformation. If <code>period = 1</code>,
linear interpolation is performed. If <code>period &gt; 1</code>, a robust STL decomposition is
first performed and a linear interpolation is applied to the seasonally adjusted data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lambda</code></td>
<td>
<p>A box cox transformation parameter. If set to <code>"auto"</code>, performs
automated lambda selection.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>role</code></td>
<td>
<p>Not used by this step since no new variables are
created.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>trained</code></td>
<td>
<p>A logical to indicate if the quantities for preprocessing have been estimated.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lambdas_trained</code></td>
<td>
<p>A named numeric vector of lambdas. This is <code>NULL</code> until computed
by <code>recipes::prep()</code>. Note that, if the original data are integers, the mean
will be converted to an integer to maintain the same a data type.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>skip</code></td>
<td>
<p>A logical. Should the step be skipped when the recipe
is baked by <code>bake.recipe()</code>? While all operations are baked when <code>prep.recipe()</code> is run,
some operations may not be able to be conducted on new data (e.g. processing the outcome variable(s)).
Care should be taken when using <code>skip = TRUE</code> as it may affect the computations for subsequent operations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>id</code></td>
<td>
<p>A character string that is unique to this step to identify it.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>A <code>step_ts_clean</code> object.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The <code>step_ts_clean()</code> function is designed specifically to handle time series
using seasonal outlier detection methods implemented in the Forecast R Package.
</p>
<p><strong>Cleaning Outliers</strong>
</p>
<p>#' Outliers are replaced with missing values using the following methods:
</p>

<ol>
<li>
<p> Non-Seasonal (<code>period = 1</code>): Uses <code>stats::supsmu()</code>
</p>
</li>
<li>
<p> Seasonal (<code>period &gt; 1</code>): Uses <code>forecast::mstl()</code> with <code>robust = TRUE</code> (robust STL decomposition)
for seasonal series.
</p>
</li>
</ol>
<p><strong>Imputation using Linear Interpolation</strong>
</p>
<p>Three circumstances cause strictly linear interpolation:
</p>

<ol>
<li> <p><strong>Period is 1:</strong> With <code>period = 1</code>, a seasonality cannot be interpreted and therefore linear is used.
</p>
</li>
<li> <p><strong>Number of Non-Missing Values is less than 2-Periods</strong>: Insufficient values exist to detect seasonality.
</p>
</li>
<li> <p><strong>Number of Total Values is less than 3-Periods</strong>: Insufficient values exist to detect seasonality.
</p>
</li>
</ol>
<p><strong>Seasonal Imputation using Linear Interpolation</strong>
</p>
<p>For seasonal series with <code>period &gt; 1</code>, a robust Seasonal Trend Loess (STL) decomposition is first computed.
Then a linear interpolation is applied to the seasonally adjusted data, and
the seasonal component is added back.
</p>
<p><strong>Box Cox Transformation</strong>
</p>
<p>In many circumstances, a Box Cox transformation can help. Especially if the series is multiplicative
meaning the variance grows exponentially. A Box Cox transformation can be automated by setting <code>lambda = "auto"</code>
or can be specified by setting <code style="white-space: pre;">⁠lambda = numeric value⁠</code>.
</p>


<h3>Value</h3>

<p>An updated version of <code>recipe</code> with the new step
added to the sequence of existing steps (if any). For the
<code>tidy</code> method, a tibble with columns <code>terms</code> (the
selectors or variables selected) and <code>value</code> (the
lambda estimate).
</p>


<h3>References</h3>


<ul>
<li> <p><a href="https://github.com/robjhyndman/forecast">Forecast R Package</a>
</p>
</li>
<li> <p><a href="https://otexts.com/fpp2/missing-outliers.html">Forecasting Principles &amp; Practices: Dealing with missing values and outliers</a>
</p>
</li>
</ul>
<h3>See Also</h3>

<p>Time Series Analysis:
</p>

<ul>
<li>
<p> Engineered Features: <code>step_timeseries_signature()</code>, <code>step_holiday_signature()</code>, <code>step_fourier()</code>
</p>
</li>
<li>
<p> Diffs &amp; Lags <code>step_diff()</code>, <code>recipes::step_lag()</code>
</p>
</li>
<li>
<p> Smoothing: <code>step_slidify()</code>, <code>step_smooth()</code>
</p>
</li>
<li>
<p> Variance Reduction: <code>step_box_cox()</code>
</p>
</li>
<li>
<p> Imputation: <code>step_ts_impute()</code>, <code>step_ts_clean()</code>
</p>
</li>
<li>
<p> Padding: <code>step_ts_pad()</code>
</p>
</li>
</ul>
<h3>Examples</h3>

<pre><code class="language-R">
library(dplyr)
library(tidyr)
library(recipes)

# Get missing values
FANG_wide &lt;- FANG %&gt;%
    select(symbol, date, adjusted) %&gt;%
    pivot_wider(names_from = symbol, values_from = adjusted) %&gt;%
    pad_by_time()

FANG_wide

# Apply Imputation
recipe_box_cox &lt;- recipe(~ ., data = FANG_wide) %&gt;%
    step_ts_clean(FB, AMZN, NFLX, GOOG, period = 252) %&gt;%
    prep()

recipe_box_cox %&gt;% bake(FANG_wide)

# Lambda parameter used during imputation process
recipe_box_cox %&gt;% tidy(1)



</code></pre>


</div>