<div class="container">

<table style="width: 100%;"><tr>
<td>tab_many</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Many cross-tables as one, with color helpers</h2>

<h3>Description</h3>

<p>A full-featured function to create, manipulate and format many cross-tables
as one, using colors to make the printed tab more easily readable (in R terminal or
exported to Excel with <code>tab_xl</code>).
Since objects of class <code>tab</code> are also of class <code>tibble</code>, you can then use all
<span class="pkg">dplyr</span> verbs to modify the result, like <code>select</code>,
<code>arrange</code>, <code>filter</code>
or <code>mutate</code>.
</p>
<p>Only breaks for attractions/over-representations (in green) should be
given, as a vector of positive doubles, with length between 1 and 5.
Breaks for aversions/under-representations (in orange/red) will simply be the opposite.
</p>


<h3>Usage</h3>

<pre><code class="language-R">tab_many(
  data,
  row_vars,
  col_vars,
  tab_vars,
  wt,
  pct = "no",
  color = "no",
  OR = "no",
  chi2 = FALSE,
  na = "keep",
  levels = "all",
  na_drop_all,
  cleannames = NULL,
  other_if_less_than = 0,
  other_level = "Others",
  ref = "auto",
  ref2 = "first",
  comp = "tab",
  ci = "no",
  conf_level = 0.95,
  method_cell = "wilson",
  method_diff = "ac",
  totaltab = "line",
  totaltab_name = "Ensemble",
  totrow = TRUE,
  totcol = "last",
  total_names = "Total",
  add_n = TRUE,
  add_pct = FALSE,
  digits = 0,
  subtext = "",
  filter
)

tab_get_vars(tabs, vars = c("row_var", "col_vars", "tab_vars"))

is_tab(x)

set_color_style(
  type = c("text", "bg"),
  theme = NULL,
  html_24_bit = c("blue_red", "green_red", "no"),
  custom_palette = NULL
)

get_color_style(
  mode = c("crayon", "color_code"),
  type = NULL,
  theme = NULL,
  html_24_bit = NULL
)

set_color_breaks(pct_breaks, mean_breaks, contrib_breaks)

get_color_breaks(brk, type = c("positive", "all"))
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>A data frame.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>row_vars</code></td>
<td>
<p>The row variable, which will be printed with one level per line.
If numeric, it will be converted to factor. If more than one row_var if provided,
a different table is made for each of them.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>col_vars</code></td>
<td>
<p>&lt;tidy-select&gt;
One column is printed for each level of each column variable.
For numeric variables means are calculated, in a single column.
To pass many variables you may use syntax <code>col_vars = c(col_var1, col_var2, ...)</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tab_vars</code></td>
<td>
<p>&lt;tidy-select&gt;
One subtable is made for each combination of levels of the tab variables.
To pass many variables you may use syntax <code>tab_vars = c(tab_var1, tab_var2, ...)</code>.
All tab variables are converted to factor. Leave empty to make a simple table.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>wt</code></td>
<td>
<p>A weight variable, of class numeric. Leave empty for unweighted results.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pct</code></td>
<td>
<p>The type of percentages to calculate :
</p>

<ul>
<li> <p><code>"row"</code>: row percentages.
</p>
</li>
<li> <p><code>"col"</code>: column percentages.
</p>
</li>
<li> <p><code>"all"</code>: frequencies for each subtable/group, if there is <code>tab_vars</code>.
</p>
</li>
<li> <p><code>"all_tabs"</code>: frequencies for the whole (set of) table(s).
</p>
</li>
</ul>
<p>The argument is vectorised over both <code>row_vars</code> and <code>col_vars</code>. You can then write as
the following :
<code>pct = list(row_var1 = list("row", "col", "col"), row_var2 = list("col", "row", "row"))</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>color</code></td>
<td>
<p>The type of colors to print, as a single string. Vectorised over <code>row_vars</code>.
</p>

<ul>
<li> <p><code>"no"</code>: by default, no colors are printed.
</p>
</li>
<li> <p><code>"diff"</code>: color percentages and means based on cells differences from
totals (or from first cells when <code>ref = "first"</code>).
</p>
</li>
<li> <p><code>"diff_ci"</code>: color pct and means based on cells differences from totals
or first cells, removing coloring when the confidence interval of this difference
is higher than the difference itself.
</p>
</li>
<li> <p><code>"after_ci"</code>: idem, but cut off the confidence interval from the
difference first.
</p>
</li>
<li> <p><code>"contrib"</code>: color cells based on their contribution to variance
(except mean columns, from numeric variables).
</p>
</li>
<li> <p><code>"OR"</code>: for <code>pct == "col"</code> or <code>pct == "row"</code>,
color based on odds ratios (or relative risks ratios)
</p>
</li>
<li> <p><code>"auto"</code>: frequencies (<code>pct = "all"</code>, <code>pct = "all_tabs"</code>)
and counts are colored with <code>"contrib"</code>.
When <code>ci = "diff"</code>, row and col percentages are colored with "after_ci" ;
otherwise they are colored with "diff".
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>OR</code></td>
<td>
<p>With <code>pct = "row"</code> or <code>pct = "col"</code>, calculate and print odds ratios
(for binary variables) or relative risks ratios (for variables with 3 levels
or more).
</p>

<ul>
<li> <p><code>"no"</code>: by default, no OR are calculated.
</p>
</li>
<li> <p><code>"OR"</code>: print OR (instead of percentages).
</p>
</li>
<li> <p><code>"OR_pct"</code>: print OR, with percentages in bracket.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>chi2</code></td>
<td>
<p>Set to <code>TRUE</code> to calculate Chi2 summaries with <code>tab_chi2</code>.
Useful to print metadata, and to color cells based on their contribution to variance
(<code>color = "contrib"</code>). Vectorised over <code>row_vars</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>na</code></td>
<td>
<p>The policy to adopt with missing values. It must be a single string.
</p>

<ul>
<li> <p><code>na = "keep"</code>: by default, prints <code>NA</code>'s as explicit <code>"NA"</code> level.
</p>
</li>
<li> <p><code>na = "drop"</code>: removes <code>NA</code> levels before making each table
(tabs made with different column variables may have a different number of
observations, and won't exactly have the same total columns).
</p>
</li>
<li> <p><code>"drop_all"</code>: remove <code>NA</code>'s for all variables before making the tables.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>levels</code></td>
<td>
<p>The levels of <code>col_vars</code> to keep (for more complex selections
use <code>dplyr::select</code>). The argument is vectorised over <code>col_vars</code>.
</p>

<ul>
<li> <p><code>"all"</code>: by default, all levels are kept.
</p>
</li>
<li> <p><code>"first"</code>: only keep the first level of each <code>col_vars</code>
</p>
</li>
<li> <p><code>"auto"</code>: keep the first level when <code>col_var</code> is only two levels,
keep all levels otherwise
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>na_drop_all</code></td>
<td>
<p>&lt;tidy-select&gt;
Removes all observations with a <code>NA</code> in any of the chosen variables, for all tables
(tabs for each column variable will have the same number of observations).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>cleannames</code></td>
<td>
<p>Set to <code>TRUE</code> to clean levels names, by removing
prefix numbers like "1-", and text in parenthesis. All data formatting arguments are
passed to <code>tab_prepare</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>other_if_less_than</code></td>
<td>
<p>When set to a positive integer, levels with less count
than it will be merged into an "Others" level.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>other_level</code></td>
<td>
<p>The name of the "Other" level, as a single string.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ref</code></td>
<td>
<p>The reference cell to calculate differences and ratios
(used to print <code>colors</code>) :
</p>

<ul>
<li> <p><code>"auto"</code>: by default, cell difference from the corresponding total
(rows or cols depending on <code>pct = "row"</code> or <code>pct = "col"</code>) is
used for <code>diff</code> ; cell ratio from the first line (or col) is use for <code>OR</code>
(odds ratio/relative risks ratio).
</p>
</li>
<li> <p><code>"tot"</code>: totals are always used.
</p>
</li>
<li> <p><code>"first"</code>: calculate cell difference or ratio from the first cell
of the row or column (useful to color temporal developments).
</p>
</li>
<li> <p><code>n</code>: when <code>ref</code> is an integer, the nth row (or column) is used for comparison.
</p>
</li>
<li> <p><code>"regex"</code>: when <code>ref</code> is a string, it it used as a regular expression,
to match with the names of the rows (or columns). Be precise enough to match only one
column or row, otherwise you get a warning message.
</p>
</li>
<li> <p><code>"no"</code>: not use ref and not calculate diffs to gain calculation time.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ref2</code></td>
<td>
<p>A second reference cell is needed to calculate odds ratios
(or relative risks ratios). The first cell of the row or column is used by default.
See <code>ref</code> above for the full list of possible values.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>comp</code></td>
<td>
<p>The comparison level : by subtables/groups, or for the whole table.
Vectorised over <code>row_vars</code>.
</p>

<ul>
<li> <p><code>"tab"</code>: by default, contributions to variance,
row differences from totals/first cells, and row confidence intervals for these
differences, are calculated for each <code>tab_vars</code> group.
</p>
</li>
<li> <p><code>"all"</code>: compare cells to the general total line (provided there is
a total table with a total row), or with the reference line of the total table
when <code>ref = "first"</code>, an integer or a regular expression.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ci</code></td>
<td>
<p>The type of confidence intervals to calculate, passed to <code>tab_ci</code>.
Vectorised over <code>row_vars</code>.
</p>

<ul>
<li> <p><code>"cell"</code>: absolute confidence intervals of cells percentages.
</p>
</li>
<li> <p><code>"diff"</code>: confidence intervals of the difference between a cell and the
relative total cell (or relative first cell when <code>ref = "first"</code>).
</p>
</li>
<li> <p><code>"auto"</code>: <code>ci = "diff"</code> for means and row/col percentages,
<code>ci = "cell"</code> for frequencies ("all", "all_tabs").
</p>
</li>
</ul>
<p>By default, for percentages, with <code>ci = "cell"</code> Wilson's method is used,
and with <code>ci = "diff"</code> Wald's method along Agresti and Caffo's adjustment.
Means use classic method. This can be changed with <code>method_cell</code>
and <code>method_diff</code>. By default, with <code>ci = "cell"</code>, the result is printed
in the <code style="white-space: pre;">⁠[inf;sup]⁠</code> form. Set <code>options("tabxplor.ci_print" = "moe")</code> to print
<code>pct +- moe</code> instead.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>conf_level</code></td>
<td>
<p>The confidence level, as a single numeric between 0 and 1.
Default to 0.95 (95%).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method_cell</code></td>
<td>
<p>Character string specifying which method to use with percentages
for <code>ci = "cell"</code>. This can be one out of:
"wald", "wilson", "wilsoncc", "agresti-coull", "jeffreys", "modified wilson",
"modified jeffreys", "clopper-pearson", "arcsine", "logit", "witting", "pratt",
"midp", "lik" and "blaker". Defaults to "wilson".
See <code>BinomCI</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method_diff</code></td>
<td>
<p>Character string specifying which method to use with percentages
for <code>ci = "diff"</code>. This can be one out of: "wald", "waldcc", "ac", "score",
"scorecc", "mn", "mee", "blj", "ha", "hal", "jp". Defaults to "ac", Wald interval with
the adjustment according to Agresti, Caffo for difference in proportions and
independent samples. See <code>BinomDiffCI</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>totaltab</code></td>
<td>
<p>The total table, if there are subtables/groups
(i.e. when <code>tab_vars</code> is provided). Vectorised over <code>row_vars</code>.
</p>

<ul>
<li> <p><code>"line"</code>: by default, add a general total line (necessary for
calculations with <code>comp = "all"</code>)
</p>
</li>
<li> <p><code>"table"</code>: add a complete total table
(i.e. <code>row_var</code> by <code>col_vars</code> without <code>tab_vars</code>).
</p>
</li>
<li> <p><code>"no"</code>: not to draw any total table.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>totaltab_name</code></td>
<td>
<p>The name of the total table, as a single string.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>totrow</code></td>
<td>
<p>By default, total rows are printed.
Set to <code>FALSE</code> to remove them (after calculations if needed).
Vectorised over <code>row_vars</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>totcol</code></td>
<td>
<p>The policy with total columns. Vectorised over <code>col_vars</code>.
</p>

<ul>
<li> <p><code>"last"</code>: by default, only prints a total column for the last
column variable (of class factor, not numeric).
</p>
</li>
<li> <p><code>"each"</code>: print a total column for each column variable.
</p>
</li>
<li> <p><code>"no"</code>: remove all total columns (after calculations if needed).
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>total_names</code></td>
<td>
<p>The names of the totals, as a character vector of length one or two.
Use syntax of type <code>c("Total row", "Total column")</code> to set different names for
rows and cols.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>add_n</code></td>
<td>
<p>For <code>pct = "row"</code> or <code>pct = "col"</code>, set to <code>FALSE</code> not to add another
column or row with unweighted counts (<code>n</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>add_pct</code></td>
<td>
<p>Set to <code>TRUE</code> to add a column with the frequencies of the row
variable (for <code>pct = "row"</code>) or a row with the frequencies of the column variable
(for  <code>pct = "col"</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>digits</code></td>
<td>
<p>The number of digits to print, as a single integer, or an integer vector
the same length as <code>col_vars</code>. The argument is vectorisez over <code>col_vars</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>subtext</code></td>
<td>
<p>A character vector to print rows of legend under the table.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>filter</code></td>
<td>
<p>A <code>dplyr::filter</code> to apply to the data frame
first, as a single string (which will be converted to code, i.e. to a call).
Useful when printing multiples tabs with <code>tibble::tribble</code>,
to use different filters for similar tables or simply make the field of observation
more visible into the code.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>tabs</code></td>
<td>
<p>A <code>tibble</code> of class <code>tab</code>, made with <code>tab</code>,
<code>tab_many</code> or <code>tab_plain</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>vars</code></td>
<td>
<p>In <code>tab_get_vars</code>, a character vector containing the wanted vars names:
<code>"row_var"</code>, <code>"col_vars"</code> or <code>"tab_vars"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>A object to test with <code>is_tab</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>type</code></td>
<td>
<p>Default to <code>"positive"</code>, which just print breaks for positive spreads.
Set to <code>all</code> to get breaks for negative spreads as well.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>theme</code></td>
<td>
<p>For <code>set_color_style</code> and <code>get_color_style</code>, is your console
or html table background <code>"light"</code> or <code>"dark"</code> ? Default to RStudio theme.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>html_24_bit</code></td>
<td>
<p>Use 24bits colors palettes for html tables : set to <code>"green_red"</code>
or <code>"blue_red"</code>. Only with <code>mode = "color_code"</code> (not <code>mode = "crayon"</code>) and
<code style="white-space: pre;">⁠theme = "light⁠</code>. Default to <code>getOption("tabxplor.color_html_24_bit")</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>custom_palette</code></td>
<td>
<p>Possibility to provide a custom color styles, as a character
vector of 10 html color codes (the five first for over-represented numbers,
the five last for under-represented ones). The result is saved to
<code>options("tabxplor.color_style")</code>. To discard, relaunch the function with
<code>custom_palette = NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mode</code></td>
<td>
<p>By default, <code>get_color_style</code> returns a list of <span class="pkg">crayon</span> coloring
functions. Set to <code>"color_code"</code> to return html color codes.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pct_breaks</code></td>
<td>
<p>If they are to be changed, the breaks used for percentages.
Default to <code>c(0.05, 0.1, 0.2, 2, 0.3)</code> : first color used when the pct of a cell
is +5% superior to the pct of the related total ; second color used when
it is +10% superior ; third +20% superior ; fourth *2 superior ;
fifth +30% superior. When &gt; 1, it does not take differences but ratio.
The opposite for cells inferior to the total (without the *2 rule).
With <code>color = "after_ci"</code>, the first break is subtracted from all breaks
(default becomes <code>c(0, 0.05, 0.15, 2, 0.25)</code> : +0%, +5%, +15%, *2, +25%).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mean_breaks</code></td>
<td>
<p>If they are to be changed, the breaks used for means.
Default to <code>c(1.15, 1.5, 2, 4)</code> : first color used when the mean of a cell
is superior to 1.15 times the mean of the related total row ; second color
used when it is superior to 1.5 times ; etc.
The opposite for cells inferior to the total.
With <code>color = "after_ci"</code>, the first break is divided from all breaks
(default becomes <code>c(1, 1.3, 1.7, 3.5)</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>contrib_breaks</code></td>
<td>
<p>If they are to be changed, the breaks used for contributions to
variance. Default to <code>c(1, 2, 5, 10)</code> : first color used when the contribution of
a cell is superior to the mean contribution ; second color used when it is superior to
2 times the mean contribution ; etc. The global color (for example green or
red/orange) is given by the sign of the spread.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>brk</code></td>
<td>
<p>When missing, return all color breaks. Specify to return a given color
break, among <code>"pct"</code>, <code>"mean"</code>, <code>"contrib"</code>, <code>"pct_ci"</code> and
<code>"mean_ci"</code>.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A <code>tibble</code> of class <code>tab</code>, possibly with colored reading helpers.
When there are two <code>row_vars</code> or more, a list of <code>tibble</code> of class <code>tab</code>.
All non-text columns are of class <code>fmt</code>, storing all
the data necessary to print formats and colors. Columns with <code>row_var</code> and
<code>tab_vars</code> are of class <code>factor</code> : every added <code>factor</code> will be
considered as a <code>tab_vars</code> and used for grouping. To add text columns without
using them in calculations, be sure they are of class <code>character</code>.
</p>
<p>A list with the variables names.
</p>
<p>A single logical.
</p>
<p>Set global options <code>"tabxplor.color_style_type"</code> and
<code>"tabxplor.color_style_theme"</code>, used when printing <code>tab</code> objects.
</p>
<p>A vector of crayon color functions, or a vector of color html codes.
</p>
<p>Set the global option "tabxplor.color_breaks" as a list different double
vectors, and also returns it invisibly.
</p>
<p>The color breaks as a double vector, or list of double vectors.
</p>


<h3>Functions</h3>


<ul>
<li> <p><code>tab_get_vars()</code>: Get the variables names of a <span class="pkg">tabxplor</span> <code>tab</code>
</p>
</li>
<li> <p><code>is_tab()</code>: a test function for class tabxplor_tab
</p>
</li>
<li> <p><code>set_color_style()</code>: define the color style used to print <code>tab</code>.
</p>
</li>
<li> <p><code>get_color_style()</code>: get color styles as <span class="pkg">crayon</span> functions or html codes.
</p>
</li>
<li> <p><code>set_color_breaks()</code>: set the breaks used to print colors
</p>
</li>
<li> <p><code>get_color_breaks()</code>: get the breaks currently used to print colors
</p>
</li>
</ul>
<h3>Examples</h3>

<pre><code class="language-R"># Make a summary table with many col_vars, showing only one specific level :

library(dplyr)
first_lvs &lt;- c("Married", "$25000 or more", "Strong republican", "Protestant")
data &lt;- forcats::gss_cat %&gt;% mutate(across(
  where(is.factor),
  ~ forcats::fct_relevel(., first_lvs[first_lvs %in% levels(.)])
))
tab_many(data, race, c(marital, rincome, partyid, relig, age, tvhours),
         levels = "first", pct = "row", chi2 = TRUE, color = "auto")


# Can be used with map and tribble to program several tables with different parameters
#  all at once, in a readable way:

library(purrr)
library(tibble)
pmap(
  tribble(
    ~row_var, ~col_vars       , ~pct , ~filter              , ~subtext               ,
    "race"  , "marital"       , "row", NULL                 , "Source: GSS 2000-2014",
    "relig" , c("race", "age"), "row", "year %in% 2000:2010", "Source: GSS 2000-2010",
    NA_character_, "race"     , "no" , NULL                 , "Source: GSS 2000-2014",
  ),
  .f = tab_many,
  data = forcats::gss_cat, color = "auto", chi2 = TRUE)

set_color_style(type = "bg")
set_color_breaks(
  pct_breaks = c(0.05, 0.15, 0.3),
  mean_breaks = c(1.15, 2, 4),
  contrib_breaks = c(1, 2, 5)
)
</code></pre>


</div>