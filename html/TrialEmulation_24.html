<div class="container">

<table style="width: 100%;"><tr>
<td>trial_msm</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Fit the marginal structural model for the sequence of emulated trials</h2>

<h3>Description</h3>

<p>Apply a weighted pooled logistic regression to fit the marginal structural model for the sequence of emulated trials
and calculates the robust covariance matrix  of parameter using the sandwich estimator.
</p>


<h3>Usage</h3>

<pre><code class="language-R">trial_msm(
  data,
  outcome_cov = ~1,
  estimand_type = c("ITT", "PP", "As-Treated"),
  model_var = NULL,
  first_followup = NA,
  last_followup = NA,
  analysis_weights = c("asis", "unweighted", "p99", "weight_limits"),
  weight_limits = c(0, Inf),
  include_followup_time = ~followup_time + I(followup_time^2),
  include_trial_period = ~trial_period + I(trial_period^2),
  where_case = NA,
  glm_function = c("glm", "parglm"),
  use_sample_weights = TRUE,
  quiet = FALSE,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>A <code>data.frame</code> containing all the required variables in the person-time format, i.e., the  ‘long’ format.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>outcome_cov</code></td>
<td>
<p>A RHS formula with baseline covariates to be adjusted for in the marginal structural model for the
emulated trials. Note that if a time-varying covariate is specified in <code>outcome_cov</code>, only its value at each of the
trial baselines will be included in the expanded data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>estimand_type</code></td>
<td>
<p>Specify the estimand for the causal analyses in the sequence of emulated trials. <code>estimand_type = "ITT"</code> will perform intention-to-treat analyses, where treatment switching after trial baselines are ignored.
<code>estimand_type = "PP"</code> will perform per-protocol analyses, where individuals' follow-ups are artificially censored
and inverse probability of treatment weighting is applied. <code>estimand_type = "As-Treated"</code> will fit a standard
marginal structural model for all possible treatment sequences, where individuals' follow-ups are not artificially
censored  but treatment switching after trial baselines are accounted for by applying inverse probability of
treatment weighting.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model_var</code></td>
<td>
<p>Treatment variables to be included in the marginal structural model for the emulated trials.
<code>model_var = "assigned_treatment"</code> will create a variable <code>assigned_treatment</code> that is the assigned treatment at
the trial baseline, typically used for ITT and per-protocol analyses. <code>model_var = "dose"</code> will create a variable
<code>dose</code> that is the cumulative number of  treatments received since the trial baseline, typically used in as-treated
analyses.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>first_followup</code></td>
<td>
<p>First follow-up time/visit in the trials to be included in the marginal structural model for
the outcome event.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>last_followup</code></td>
<td>
<p>Last follow-up time/visit in the trials to be included in the marginal structural model for the
outcome event.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>analysis_weights</code></td>
<td>
<p>Choose which type of weights to be used for fitting the marginal structural model for the
outcome event.
</p>

<ul>
<li> <p><code>"asis"</code>: use the weights as calculated.
</p>
</li>
<li> <p><code>"p99"</code>: use weights truncated at the 1st and 99th percentiles (based on the distribution of weights
in the entire sample).
</p>
</li>
<li> <p><code>"weight_limits"</code>: use weights truncated at the values specified in <code>weight_limits</code>.
</p>
</li>
<li> <p><code>"unweighted"</code>: set all analysis weights to 1, even if treatment weights or censoring weights were calculated.
</p>
</li>
</ul>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weight_limits</code></td>
<td>
<p>Lower and upper limits to truncate weights, given as <code>c(lower, upper)</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>include_followup_time</code></td>
<td>
<p>The model to include the follow up time/visit of the trial (<code>followup_time</code>) in the
marginal structural model, specified as a RHS formula.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>include_trial_period</code></td>
<td>
<p>The model to include the trial period (<code>trial_period</code>) in the marginal structural model,
specified as a RHS formula.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>where_case</code></td>
<td>
<p>Define conditions using variables specified in <code>where_var</code> when fitting a marginal structural model
for a subgroup of the individuals. For example, if <code>where_var= "age"</code>, <code>where_case = "age &gt;= 30"</code> will only fit the
marginal structural model to the subgroup of individuals. who are 30 years old or above.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>glm_function</code></td>
<td>
<p>Specify which glm function to use for the marginal structural model from the <code>stats</code> or <code>parglm</code>
packages. The default function is the <code>glm</code> function in the <code>stats</code> package. Users can also specify <code>glm_function = "parglm"</code> such that the <code>parglm</code> function in the <code>parglm</code> package can be used for fitting generalized linear models
in parallel. The default control setting for  <code>parglm</code> is <code>nthreads = 4</code> and <code>method = "FAST"</code>, where four cores
and Fisher information are used for faster computation. Users can change the default control setting by passing the
arguments <code>nthreads</code> and <code>method</code> in the <code>parglm.control</code> function of the <code>parglm</code> package, or alternatively, by
passing a <code>control</code> argument with a list produced by <code>parglm.control(nthreads = , method = )</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>use_sample_weights</code></td>
<td>
<p>Use case-control sampling weights in addition to inverse probability weights for treatment
and censoring. <code>data</code> must contain a column <code>sample_weight</code>. The final weights used in the pooled logistic
regression are calculated as <code>weight = weight * sample_weight</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>quiet</code></td>
<td>
<p>Suppress the printing of progress messages and summaries of the fitted models.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Additional arguments passed to <code>glm_function</code>. This may be used to specify initial values of parameters or
arguments to <code>control</code>. See stats::glm, parglm::parglm and <code>parglm::parglm.control()</code> for more information.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The model formula is constructed by combining the arguments <code>outcome_cov</code>, <code>model_var</code>,
<code>include_followup_time</code>, and <code>include_trial_period</code>.
</p>


<h3>Value</h3>

<p>Object of class <code>TE_msm</code> containing
</p>

<dl>
<dt>model</dt>
<dd>
<p>a <code>glm</code> object</p>
</dd>
<dt>robust</dt>
<dd>
<p>a list containing a summary table of estimated regression coefficients and the robust covariance
matrix</p>
</dd>
<dt>args</dt>
<dd>
<p>a list contain the parameters used to prepare and fit the model</p>
</dd>
</dl>
</div>